services:
    cadvisor:
        image: ghcr.io/google/cadvisor
        container_name: cadvisor
        restart: unless-stopped
        devices:
            - /dev/kmsg
        privileged: true
        ports:
            - '55032:8080'
        volumes:
            - '/dev/disk/:/dev/disk:ro'
            - '/var/lib/docker/:/var/lib/docker:ro'
            - '/sys:/sys:ro'
            - '/var/run:/var/run:ro'
            - '/:/rootfs:ro'

    node_exporter:
        image: quay.io/prometheus/node-exporter
        container_name: node_exporter
        command:
        - '--path.rootfs=/host'
        network_mode: host # The node_exporter listens on HTTP port 9100 by default. See the --help output for more options.
        pid: host
        restart: unless-stopped
        volumes:
        - '/:/host:ro,rslave'

    prometheus:
        image: prom/prometheus
        container_name: prometheus
        restart: unless-stopped
        depends_on:
        - cadvisor
        - node_exporter
        volumes:
            - "${NETMON_PROMETHEUS_VOLUME_CONFIG}:/etc/prometheus"
            - "${NETMON_PROMETHEUS_VOLUME_DATA}:/prometheus"
        ports:
            - '36245:9090'

    grafana:
        image: grafana/grafana-enterprise
        container_name: grafana
        user: ${OP_PUID}:${OP_PGID}
        depends_on:
        - prometheus
        restart: unless-stopped
        volumes:
            - "${NETMON_GRAFANA_VOLUME_DATA}:/var/lib/grafana"
        ports:
        - '9042:3000'
